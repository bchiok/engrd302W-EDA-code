---
title: "Exploratory Data Analysis: COVID-19 Cases and Average Annual Out of Pocket Healthcare Costs in 2022"
author: "Ben, Emma, and Felix"
date: "2024-10-03"
output: html_document
---

```{r setup, include=FALSE}

#install.packages("tidyverse")
#install.packages("janitor")
#install.packages("pacman")
#install.packages("devtools")
#library(devtools)
#devtools::install_github("UrbanInstitute/urbnmapr")

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
pacman::p_load(tidyverse, janitor, urbnmapr)

state_keys <- tibble(state = state.name, ab = state.abb) %>%
  add_row(state = "District of Columbia", ab = "DC") %>% 
  rename(state_name = state)
state_keys

library(tidyverse, janitor, urbnmapr)

```

### Introduction - Needs to change with new data

Our goal in this analysis is to examine how percent change in COVID-19 cases between December 31st, 2020 and January 14th, 2021 affected average annual dollars spent out of pocket per person on medical care in 2022. Specifically, how the cost of out of pocket medical care has been affected in counties with high COVID-19 cases. In this analysis, we will be utilizing two different datasets. The first is a dataset that describes the average annual dollars spent out of pocket per person on medical care in 2022. This information is from the Department of Health and Human Services' Agency for Healthcare Research and Quality (AHRQ) Medical Expenditure Panel Survey (2022) with demographic and health data from the U.S. Census American Community Survey (2018-2022). The second dataset describes the percent change in seven day rolling average of cases of COVID-19 14-day change between December 31st, 2020 and January 14th, 2021. This information is from the New York Times national database of COVID-19 cases and deaths.

```{r downloading datasets - Probably Remove, include=FALSE}

avghealthcarecost2022 <- read.csv("data/healthcarecosts2022.csv")
head(avghealthcarecost2022)

# Possibly Remove
rate2021<-read.csv("data/covidrate2021.csv")
head(rate2021)

# New stuff added
cases2021<-read.csv("data/us-counties-2021.csv")
head(cases2021)
cases2022<-read.csv("data/us-counties-2022.csv")
head(cases2022)

```

### Data Cleaning

```{r cleaning costs}

avghealthcare_2022 <- read.csv("data/healthcarecosts2022.csv") %>% 
  row_to_names(row_number = 1) %>% 
  clean_names() %>% 
  filter(!(sitsin_state %in% c("AS", "GU", "MP", "PR", "VI"))) %>% 
  left_join(state_keys, by = c("sitsin_state" = "ab")) %>% 
  rename(
    county = geo_id_name,
    state = state_name,
    fips = geo_id,
    avg_cost_2022 = totslf_avg) %>%
  mutate(fips = as.numeric(fips)) %>% 
  select("county","state", "fips", "avg_cost_2022")
head(avghealthcare_2022)
unique(avghealthcare_2022$state)

CT_cost <- avghealthcare_2022 %>% 
  filter(state == "Georgia")
head(CT_cost)
unique(CT_cost$county)

```


```{r cleaning cases -NEW, message=FALSE}

covidcases2021 <- read.csv("data/us-counties-2021.csv") %>% 
  select("date", "geoid", "county", "state", "cases_avg_per_100k") %>%
  pivot_wider(names_from = "date",
              values_from = "cases_avg_per_100k") %>%
  rowwise() %>%
  mutate(covidcases_2021 = sum(c_across(starts_with("2021")), na.rm = T) / 365,
         fips = as.numeric(str_remove(geoid, "USA-"))) %>%
  select("county", "state", "fips", "covidcases_2021")
head(covidcases2021)


covidcases2022 <- read.csv("data/us-counties-2022.csv") %>% 
select("date", "geoid", "county", "state", "cases_avg_per_100k") %>%
  pivot_wider(names_from = "date",
              values_from = "cases_avg_per_100k") %>%
  rowwise() %>%
  mutate(covidcases_2022 = sum(c_across(starts_with("2022")), na.rm = T) / 365,
         fips = as.numeric(str_remove(geoid, "USA-"))) %>%
  select("county", "state", "fips", "covidcases_2022")
head(covidcases2022)

covid_cases <- covidcases2021 %>% 
  left_join(covidcases2022, by = c("county","state", "fips"))
unique(covid_cases$state)
covid_cases <- covid_cases %>% 
  filter(!(state %in% c("Puerto Rico", "Northern Mariana Islands", "Virgin Islands", "American Samoa")))
unique(covid_cases$state)
head(covid_cases)

CT <- covid_cases %>% 
  filter(state == "Georgia")
CT

```


```{r creating dataset - NEW}

covid_costs <- avghealthcare_2022 %>% 
  left_join(covid_cases, by = c("county","state", "fips"))
head(covid_costs)

# covid cases = total number of cases for the year in that specific county

```

```{r creating dataset - ORIGINAL, include=FALSE}

covid_healthcare_costs <- left_join(avghealthcarecost2022, rate2021, by=c("GeoID", "Geography.Name","Sits.in.State")) %>%
  row_to_names(row_number = 1) %>%
  clean_names() %>%
  rename(
    county = geo_id_name,
    state = sitsin_state,
    county_fips = geo_id,
    avg_healthcarecost = totslf_avg,
    year = time_frame,
    avg_covidcases = pc_av7dy_2wk_cases,
    time_frame = time_frame_2) %>%
  select("county","state", "county_fips", "avg_healthcarecost", "year", "avg_covidcases", "time_frame") %>%
  drop_na() %>%
  mutate(avg_healthcarecost = as.numeric(avg_healthcarecost),
         avg_covidcases = as.numeric(avg_covidcases))

head(covid_healthcare_costs)

```

### Codebook

```{r codebook, echo = FALSE, results = TRUE}

Variable  <- c("county","state","fips","average annual healthcare cost", "COVID-19 cases")
Definition <- c("county data was collected in", "state that county resides in", "unique code given to each count in the US", "out of pocket cost per person in 2022 measured in US dollars", "cummalitive COVID-19 cases  per year")
d <- data.frame(Variable,Definition)
knitr::kable(d)

```


### Preliminary Data Analysis - Needs to change with new data



```{r }
summary(covid_healthcare_costs$avg_healthcarecost)
summary(covid_healthcare_costs$avg_covidcases)
```

In 2022, across the United States, the average out of pocket healthcare cost per individual was $1,101 with a minimum of $520 and a maximum of $1,890 spend per person. In the first two week of 2021, the average percent change in COVID-19 cases was an increase of roughly 45% while some counties had a decrease of 100% of COVID-19 cases and others had an increase of almost 3,000% in cases.

### Map



```{r map}

## If you want to use new data, the dataset is called covid_costs - Emma

us_covid_healthcare_costs <- left_join(covid_healthcare_costs, counties, by = c("county_fips")) 

us_covid_healthcare_costs %>%
  ggplot(aes(long, lat, group = group, fill = avg_healthcarecost)) +
  geom_polygon(color=NA) +
  scale_fill_gradientn(colors=rev(rainbow(7)))+
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  theme_void() +
  labs(fill = "")

us_covid_healthcare_costs %>%
  ggplot(aes(long, lat, group = group, fill = avg_covidcases)) +
  geom_polygon(color=NA) +
  scale_fill_gradientn(colors=rev(rainbow(7)))+
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  theme_void() +
  labs(fill = "")

```

#### Removing outliers
```{r}
summary(covid_healthcare_costs$avg_covidcases)
summary(covid_healthcare_costs$avg_healthcarecost)

IQR(covid_healthcare_costs$avg_covidcases, na.rm=T)
Q1=quantile(covid_healthcare_costs$avg_covidcases, .25, na.rm=T)
Q3=quantile(covid_healthcare_costs$avg_covidcases, .75, na.rm=T)
IQR1=Q3-Q1
Q1cost=quantile(covid_healthcare_costs$avg_healthcarecost, .25, na.rm=T)
Q3cost=quantile(covid_healthcare_costs$avg_healthcarecost, .75, na.rm=T)
IQR2=Q3cost-Q1cost

covid_healthcare_costs_cleaned <- covid_healthcare_costs %>% 
  mutate(is_outlier=avg_covidcases<(Q1-1.5*IQR1) | avg_covidcases>(Q3+1.5*IQR1)|avg_healthcarecost<(Q1cost-1.5*IQR2) | avg_healthcarecost>(Q3cost+1.5*IQR2)) %>% 
  filter(!is_outlier)

summary(covid_healthcare_costs_cleaned$avg_healthcarecost)
summary(covid_healthcare_costs_cleaned$avg_covidcases)
```

#### Standardizing data as a percent difference from the median for cost and case increase
```{r}
us_covid_healthcare_costs1 <- left_join(covid_healthcare_costs_cleaned, counties, by = c("county_fips"))


mediancost<-median(us_covid_healthcare_costs1$avg_healthcarecost, na.rm=T)
mediancaseincrease<-median(us_covid_healthcare_costs1$avg_covidcases, na.rm=T)

standardized_us_covid_healthcare_costs <- us_covid_healthcare_costs1 %>%
  mutate(standardhealthcarecost=((avg_healthcarecost-mediancost)/mediancost)*100,
         standardcaseincrease=((avg_covidcases-mediancaseincrease)/mediancaseincrease)*100)

summary(standardized_us_covid_healthcare_costs$standardhealthcarecost)
summary(standardized_us_covid_healthcare_costs$standardcaseincrease)

```
#### New map w standardization
```{r}
standardized_us_covid_healthcare_costs %>%
  ggplot(aes(long, lat, group = group, fill = standardhealthcarecost)) +
  geom_polygon() +
  scale_fill_gradientn(colors=rev(rainbow(5)))+
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  theme_void() +
  labs(fill = "")

standardized_us_covid_healthcare_costs %>%
  ggplot(aes(long, lat, group = group, fill = standardcaseincrease)) +
  geom_polygon() +
  scale_fill_gradientn(colors=rev(rainbow(5)))+
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  theme_void() +
  labs(fill = "")
```















