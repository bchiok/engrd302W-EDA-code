---
title: "Analysis.rmd"
author: "Ben, Emma, and Felix"
date: "2024-10-03"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
pacman::p_load(tidyverse, janitor, urbnmapr)

state_keys <- tibble(state = state.name, ab = state.abb) %>%
  rename(state_name = state)
state_keys

library(tidyverse, janitor, urbnmapr)


```

# Average Annual Out of Pocket Healthcare Cost and COVID-19 Cases by County

## Introduction - Needs to change with new data

Our goal in this analysis is to examine how percent change in COVID-19 cases between December 31st, 2020 and January 14th, 2021 affected average annual dollars spent out of pocket per person on medical care in 2022. Specifically, how the cost of out of pocket medical care has been affected in counties with high COVID-19 cases. In this analysis, we will be utilizing two different datasets. The first is a dataset that describes the average annual dollars spent out of pocket per person on medical care in 2022. This information is from the Department of Health and Human Services' Agency for Healthcare Research and Quality (AHRQ) Medical Expenditure Panel Survey (2022) with demographic and health data from the U.S. Census American Community Survey (2018-2022). The second dataset describes the percent change in seven day rolling average of cases of COVID-19 14-day change between December 31st, 2020 and January 14th, 2021. This information is from the New York Times national database of COVID-19 cases and deaths.

```{r downloading datasets}

avghealthcarecost2022<-read.csv("data/policymaptest.csv")
head(avghealthcarecost2022)

# Possibly Remove
rate2021<-read.csv("data/covidrate2021.csv")
head(rate2021)

# New stuff added
cases2021<-read.csv("data/us-counties-2021.csv")
head(cases2021)
cases2022<-read.csv("data/us-counties-2022.csv")
cases2022

```

```{r cleaning cases -NEW}

annualcases2021 <- cases2021 %>% 
  select(!"deaths") %>% 
  pivot_wider(names_from = "date",
              values_from = "cases") %>% 
  rowwise() %>%
  mutate(annualcases_2021 = sum(c_across(starts_with("2021")), na.rm = T)) %>%
  select("county", "state", "fips", "annualcases_2021")
head(annualcases2021)

annualcases2022 <- cases2022 %>% 
  select(!"deaths") %>% 
  pivot_wider(names_from = "date",
              values_from = "cases") %>% 
  rowwise() %>%
  mutate(annualcases_2022 = sum(c_across(starts_with("2022")), na.rm = T)) %>%
  select("county", "state", "fips", "annualcases_2022")
head(annualcases2022)

```


```{r creating dataset - NEW}

healthcare_2022 <- avghealthcarecost2022 %>% 
  row_to_names(row_number = 1) %>% 
  clean_names() %>% 
  left_join(state_keys, by = c("sitsin_state" = "ab")) %>% 
  rename(
    county = geo_id_name,
    state = state_name,
    fips = geo_id,
    avg_cost_2022 = totslf_avg) %>%
  mutate(fips = as.numeric(fips)) %>% 
  select("county","state", "fips", "avg_cost_2022")
head(healthcare_2022)

covid_costs <- healthcare_2022 %>% 
  left_join(annualcases2021, by = c("county","state", "fips")) %>% 
  left_join(annualcases2022, by = c("county","state", "fips"))
head(covid_costs)

# Annual cases = total number of cases for the year in that specific county

```

```{r creating dataset - ORIGINAL}

covid_healthcare_costs <- left_join(avghealthcarecost2022, rate2021, by=c("GeoID", "Geography.Name","Sits.in.State")) %>% 
  row_to_names(row_number = 1) %>% 
  clean_names() %>% 
  rename(
    county = geo_id_name,
    state = sitsin_state,
    county_fips = geo_id,
    avg_healthcarecost = totslf_avg,
    year = time_frame,
    avg_covidcases = pc_av7dy_2wk_cases,
    time_frame = time_frame_2) %>% 
  select("county","state", "county_fips", "avg_healthcarecost", "year", "avg_covidcases", "time_frame") %>% 
  drop_na() %>% 
  mutate(avg_healthcarecost = as.numeric(avg_healthcarecost),
         avg_covidcases = as.numeric(avg_covidcases)) 
  
head(covid_healthcare_costs)

```

## Codebook -Needs to change with new data

Variable | Definition

county | The county where the data is from

state | The state the county is in

county_fips | A code that is unique to each county in the U.S.

avg_healthcarecost | The average out of pocket medical care cost per person

year | The year the data was collected

avg_covidcases | Percent change in seven day rolling average of cases of COVID-19 14-day change

time_frame | The last day of the two week period that COVID-19 cases were recorded


## Preliminary Data Analysis - Needs to change with new data



```{r }
summary(covid_healthcare_costs$avg_healthcarecost)
summary(covid_healthcare_costs$avg_covidcases)
```

In 2022, across the United States, the average out of pocket healthcare cost per individual was $1,101 with a minimum of $520 and a maximum of $1,890 spend per person. In the first two week of 2021, the average percent change in COVID-19 cases was an increase of roughly 45% while some counties had a decrease of 100% of COVID-19 cases and others had an increase of almost 3,000% in cases.

## Map



```{r map}

## If you want to use new data, the dataset is called covid_costs - Emma

us_covid_healthcare_costs <- left_join(covid_healthcare_costs, counties, by = c("county_fips")) 

us_covid_healthcare_costs %>%
  ggplot(aes(long, lat, group = group, fill = avg_healthcarecost)) +
  geom_polygon(color=NA) +
  scale_fill_gradientn(colors=rev(rainbow(7)))+
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  theme_void() +
  labs(fill = "")

us_covid_healthcare_costs %>%
  ggplot(aes(long, lat, group = group, fill = avg_covidcases)) +
  geom_polygon(color=NA) +
  scale_fill_gradientn(colors=rev(rainbow(7)))+
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  theme_void() +
  labs(fill = "")

```

### Removing outliers
```{r}
IQR(covid_healthcare_costs$avg_covidcases, na.rm=T)
Q1=-5.308
Q3=55.540
IQR1=60.8475
Q1cost=1020
Q3cost=1170
IQR2=150
Q1-1.5*IQR1
covid_healthcare_costs_cleaned <- covid_healthcare_costs %>% 
  mutate(is_outlier=avg_covidcases<(Q1-1.5*IQR1) | avg_covidcases>(Q3+1.5*IQR1)|avg_healthcarecost<(Q1cost-1.5*IQR2) | avg_healthcarecost>(Q3cost+1.5*IQR2)) %>% 
  filter(!is_outlier)

summary(covid_healthcare_costs_cleaned$avg_healthcarecost)
summary(covid_healthcare_costs_cleaned$avg_covidcases)
```

### Standardizing data as a percent difference from the median for cost and case increase
```{r}
us_covid_healthcare_costs1 <- left_join(covid_healthcare_costs_cleaned, counties, by = c("county_fips"))


mediancost<-median(us_covid_healthcare_costs1$avg_healthcarecost, na.rm=T)
mediancaseincrease<-median(us_covid_healthcare_costs1$avg_covidcases, na.rm=T)

standardized_us_covid_healthcare_costs <- us_covid_healthcare_costs1 %>%
  mutate(standardhealthcarecost=((avg_healthcarecost-mediancost)/mediancost)*100,
         standardcaseincrease=((avg_covidcases-mediancaseincrease)/mediancaseincrease)*100)

summary(standardized_us_covid_healthcare_costs$standardhealthcarecost)
summary(standardized_us_covid_healthcare_costs$standardcaseincrease)

```
### New map w standardization
```{r}
standardized_us_covid_healthcare_costs %>%
  ggplot(aes(long, lat, group = group, fill = standardhealthcarecost)) +
  geom_polygon() +
  scale_fill_gradientn(colors=rev(rainbow(5)))+
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  theme_void() +
  labs(fill = "")

standardized_us_covid_healthcare_costs %>%
  ggplot(aes(long, lat, group = group, fill = standardcaseincrease)) +
  geom_polygon() +
  scale_fill_gradientn(colors=rev(rainbow(5)))+
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  theme_void() +
  labs(fill = "")
```















